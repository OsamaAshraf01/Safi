name: CI/CD Pipeline

# Trigger the pipeline on Push or Pull Request to these branches
on:
  push:
    branches: [ "main", "dev" ]
  pull_request:
    branches: [ "main", "dev" ]

jobs:
  # JOB 1: Code Quality & Testing (Runs on Ubuntu VM)
  quality-check:
    runs-on: ubuntu-latest

    steps:
    # 1. Download the code
    - name: Checkout Code
      uses: actions/checkout@v3

    # 2. Install Python 3.11
    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"
        cache: 'pip' # Caches dependencies to make subsequent runs faster

    # 3. Install Dependencies
    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt


    # 4. Check Formatting (Black)
    # The '--check' flag fails the pipeline if code isn't formatted correctly
    - name: Check Formatting (Black)
      run: black . --check

    # 5. Check Syntax (Flake8)
    - name: Lint Code (Flake8)
      run: flake8 .

    # 6. Run Tests (Pytest)
    # We set the Secret Key dummy value so Flask doesn't crash on startup
    - name: Run Tests
      env:
        SECRET_KEY: "ci_test_key"
        MONGO_URI: "mongomock://localhost"
      run: pytest

  # JOB 2: Docker Verification
  # Runs only if 'quality-check' passes. Ensures the Dockerfile actually builds.
  docker-build:
    needs: quality-check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Build Docker Image
      run: docker build . --file ./Dockerfile --tag myapp:test
